{% extends "layout.html" %}

{% block title %}
    SentryD
{% endblock %}

{% block main %}
<div id="debug-container" style="font-size: 28px;">
  <!-- JSON data will be displayed here -->
</div>

<div id="image-container">
    <img id="frontImage" alt="Front Image" style="max-width: 400px; max-height: 400px;">
    <img id="backImage" alt="Back Image" style="max-width: 400px; max-height: 400px;">
</div>
<br>
<h1>SentryD Logs</h1>
<br>
{% for row in rows %}
    <a href="/sentryd/{{ row }}">{{ row }}</a><br>
{% endfor %}
<div id="panoramaContainer" style="width: 100%; height: 400px;"></div>

<script src="https://threejs.org/build/three.js"></script>


<div id="panorama-container"></div>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
<script src="/static/panorama.js"></script>

<script>
  let lastAlarmTimestamp = null;

  function fetchData() {
    fetch('sentryjson.json')
      .then(response => response.json())
      .then(data => {
        // Check if the alarm timestamp has changed
        if (lastAlarmTimestamp !== data['SentrydAlarmT']) {
          // Create an HTML string for each key-value pair
          const htmlString = Object.entries(data)
            .map(([key, value]) => `<strong>${key}:</strong> ${value}<br>`)
            .join('');

          // Update the content in the 'debug-container' div
          document.getElementById('debug-container').innerHTML = htmlString;

          // Update the 'src' attribute of the front image
          document.getElementById('frontImage').src = '/images/front_image.jpg';
          // Update the 'src' attribute of the back image
          document.getElementById('backImage').src = '/images/back_image.jpg';

          // Check if the container exists
          const container = document.getElementById('panoramaContainer');
          if (container) {
            // Load 360-degree image using Three.js
            loadPanoramaImage('/images/360_image.jpg', container);
          }

          // Update the last alarm timestamp
          lastAlarmTimestamp = data['SentrydAlarmT'];
        }
      })
      .catch(error => console.error('Error fetching data:', error));
  }

  // Initial fetch
  fetchData();

  // Set up a timer to fetch data every 5 seconds
  setInterval(fetchData, 2000);

  function loadPanoramaImage(imageUrl, container) {
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();

    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);

    const geometry = new THREE.SphereGeometry(500, 60, 40);
    const texture = new THREE.TextureLoader().load(imageUrl);
    const material = new THREE.MeshBasicMaterial({ map: texture, side: THREE.DoubleSide });
    const sphere = new THREE.Mesh(geometry, material);

    scene.add(sphere);

    camera.position.z = 0.01;

    const animate = function () {
      requestAnimationFrame(animate);

      sphere.rotation.y += 0.005;

      renderer.render(scene, camera);
    };

    animate();
  }
</script>
{% endblock %}
