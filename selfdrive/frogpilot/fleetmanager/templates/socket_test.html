{% extends "layout.html" %}

{% block title %}
  Socket Test
{% endblock %}

{% block main %}
  <style>
    @font-face {
      font-family: 'Digital-7';
      src: url('/static/digital-7.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
  </style>
  <canvas id="radarCanvas" width="644" height="318"></canvas>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
  <script>
    const canvas = document.getElementById("radarCanvas");
    const ctx = canvas.getContext("2d");
    
    const backgroundImage = new Image();
    backgroundImage.src = "/static/background.png";
  
    const carImage = new Image();
    carImage.src = "/static/player_straight.png";

    const leadVehicleImage = new Image();
    leadVehicleImage.src = "/static/car01.png";
  
    const maxDRel = 100; // Adjust as needed
    const maxYRel = 30; // Adjust as needed
    const dRelScalingFactor = 2; // Adjust as needed

    let leadVehicleSize; // Declare leadVehicleSize
    let yRelScalingFactor; // Declare yRelScalingFactor

    const socket = io.connect('{{ server_ip }}');
  
    socket.on('radarData', function (radarState) {
      // Clear the canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
  
      // Draw the driver's car at the bottom center
      const carX = (canvas.width - carImage.width) / 2;
      const carY = canvas.height - carImage.height;

      // Calculate yRelScalingFactor using linear interpolation
      const maxyRelScalingFactor = 1;  // Scaling factor when dRel is maxDRel
      const minyRelScalingFactor = 10;  // Scaling factor when dRel is 0
      yRelScalingFactor = minyRelScalingFactor - (minyRelScalingFactor - maxyRelScalingFactor) * (radarState.leadOne.dRel / maxDRel);

      // Calculate leadVehicleSize using linear interpolation
      const maxLeadVehicleSize = 10;  // Size when dRel is maxDRel
      const minLeadVehicleSize = 50;  // Size when dRel is 0
      leadVehicleSize = minLeadVehicleSize - (minLeadVehicleSize - maxLeadVehicleSize) * (radarState.leadOne.dRel / maxDRel);

      // Draw lead vehicle (leadOne) in blue
      if (radarState.leadOne.dRel !== 0 && radarState.leadOne.dRel < maxDRel && Math.abs(radarState.leadOne.yRel) < maxYRel) {
        drawLeadVehicle(radarState.leadOne, "blue");
      }

      // Display speed at the center top with a digital font
      ctx.font = "30px 'Digital-7'";
      ctx.fillStyle = "white";
      ctx.textAlign = "center";
      const vEgo = radarState.vego * 2.237;
      ctx.fillText(`Speed: ${vEgo.toFixed(1)} mph`, canvas.width / 2, 75);
    });
  
    function drawLeadVehicle(leadData, color) {
      // Skip drawing if dRel is equal to 0
      if (leadData.dRel === 0) {
        return;
      }
  
      const leadX = (canvas.width / 2) + (leadData.yRel * yRelScalingFactor) + (leadVehicleSize / 2);
      const leadY = (canvas.height - 60) - (leadData.dRel * dRelScalingFactor) - (leadVehicleSize / 2);

      // Use leadVehicleSize in your drawLeadVehicle function
      ctx.drawImage(leadVehicleImage, leadX, leadY, leadVehicleSize, leadVehicleSize);
    }
  </script>
{% endblock %}
