{% extends "layout.html" %}

{% block title %}
    Socket Test
{% endblock %}

{% block main %}
    <canvas id="radarCanvas" width="800" height="600"></canvas>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <script>
        const canvas = document.getElementById("radarCanvas");
        const ctx = canvas.getContext("2d");

        const carWidth = 20;
        const carHeight = 40;
        const leadVehicleSize = 30;

        const maxDRel = 150; // Adjust as needed
        const maxYRel = 30; // Adjust as needed

        const socket = io.connect('http://10.0.0.41:8082');

        socket.on('radarData', function (radarState) {
            // Clear the canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw the driver's car at the bottom center
            const carX = (canvas.width - carWidth) / 2;
            const carY = canvas.height - carHeight;
            ctx.fillStyle = "blue";
            ctx.fillRect(carX, carY, carWidth, carHeight);

            // Draw lead vehicle (leadOne) in blue
            if (radarState.leadOne.dRel < maxDRel && Math.abs(radarState.leadOne.yRel) < maxYRel) {
                drawLeadVehicle(radarState.leadOne, "blue");
            }

            // Draw LiveTracks in red or orange based on oncoming attribute
            for (const liveTrack of radarState.liveTracks) {
                if (liveTrack.dRel < maxDRel && Math.abs(liveTrack.yRel) < maxYRel) {
                    const color = liveTrack.oncoming ? "orange" : "red";
                    drawLiveTrack(liveTrack, color);
                }
            }
        });

        function drawLeadVehicle(leadData, color) {
            const leadX = canvas.width / 2 + leadData.yRel * 10; // Adjust multiplier as needed
            const leadY = canvas.height - leadData.dRel * 10; // Adjust multiplier as needed

            ctx.fillStyle = color;
            ctx.fillRect(leadX - leadVehicleSize / 2, leadY - leadVehicleSize / 2, leadVehicleSize, leadVehicleSize);
        }

        function drawLiveTrack(liveTrack, color) {
            const trackX = canvas.width / 2 + liveTrack.yRel * 10; // Adjust multiplier as needed
            const trackY = canvas.height - liveTrack.dRel * 10; // Adjust multiplier as needed

            ctx.fillStyle = color;
            ctx.fillRect(trackX, trackY, 10, 10); // Adjust size as needed
        }
    </script>
{% endblock %}
